{% extends "base.html" %}

{% block content %}
<h3>Vue réseau</h3>
<p class="text-muted">Topologie simplifiée du réseau de stockage virtuel.</p>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">Contrôleur réseau</div>
      <div class="card-body" id="network-info">
        Chargement...
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">Actions</div>
      <div class="card-body">
        <button class="btn btn-primary" id="btn-refresh">Rafraîchir</button>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6 mb-4">
    <div class="card h-100">
      <div class="card-header">Nœuds enregistrés</div>
      <div class="card-body">
        <table class="table table-sm" id="table-nodes-net">
          <thead>
            <tr>
              <th>ID</th>
              <th>Host</th>
              <th>Port</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-md-6 mb-4">
    <div class="card h-100">
      <div class="card-header">Fichiers dans le cloud</div>
      <div class="card-body">
        <table class="table table-sm" id="table-files-net">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Taille</th>
              <th>Statut</th>
              <th>Primaires</th>
              <th>Réplica</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function fetchJSON(url, options) {
  const res = await fetch(url, options);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return await res.json();
}

async function refreshNetworkView() {
  const infoEl = document.getElementById('network-info');
  const nodesTbody = document.querySelector('#table-nodes-net tbody');
  const filesTbody = document.querySelector('#table-files-net tbody');
  infoEl.textContent = 'Chargement...';
  nodesTbody.innerHTML = '';
  filesTbody.innerHTML = '';
  try {
    const status = await fetchJSON('/api/network/full-status');
    if (!status.running) {
      infoEl.textContent = 'Contrôleur réseau arrêté.';
      return;
    }
    infoEl.innerHTML = `Contrôleur actif sur <strong>${status.host}:${status.port}</strong>. Nœuds actifs: ${status.nodes.length}. Fichiers: ${status.files.length}.`;

    status.nodes.forEach(n => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${n.id}</td><td>${n.host}</td><td>${n.port}</td><td>${n.status}</td>`;
      nodesTbody.appendChild(tr);
    });

    status.files.forEach(f => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${f.file_name}</td><td>${f.file_size}</td><td>${f.status}</td><td>${f.primary_nodes.join(', ')}</td><td>${f.replica_nodes.join(', ')}</td>`;
      filesTbody.appendChild(tr);
    });
  } catch (e) {
    infoEl.textContent = 'Erreur de chargement: ' + e.message;
  }
}

window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btn-refresh').addEventListener('click', refreshNetworkView);
  refreshNetworkView();
});
</script>
{% endblock %}
